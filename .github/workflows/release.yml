name: Release Pipeline

on:
  push:
    branches:
      - "main"
      - "release/v0.2.0"  # Temporary: for testing before merge
    paths:
      - 'wheel_overlay/**'
      - '.github/workflows/release.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'wheel_overlay/**'
      - '.github/workflows/release.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ./wheel_overlay

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Validate Property Tests
      run: |
        Write-Host "Validating property test directives..."
        $result = .\Scripts\Validate-PropertyTests.ps1
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Property test validation failed. Some tests are missing conditional compilation directives."
          Write-Host "Run '.\Scripts\Add-PropertyTestDirectives.ps1' to fix the issues."
          exit 1
        }
        Write-Host "All property tests have correct directives."
      shell: pwsh

    - name: Determine Build Configuration
      id: config
      run: |
        if ("${{ github.event_name }}" -eq "pull_request") {
          $config = "FastTests"
          Write-Host "Using FastTests configuration for PR build (10 iterations)"
        } else {
          $config = "Release"
          Write-Host "Using Release configuration for merge build (100 iterations)"
        }
        echo "BUILD_CONFIG=$config" >> $env:GITHUB_ENV
        echo "configuration=$config" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: |
        Write-Host "Building with ${{ env.BUILD_CONFIG }} configuration..."
        dotnet build --no-restore --configuration ${{ env.BUILD_CONFIG }} /p:TreatWarningsAsErrors=true

    - name: Test
      run: |
        Write-Host "Running tests with ${{ env.BUILD_CONFIG }} configuration..."
        $startTime = Get-Date
        dotnet test --no-build --verbosity normal --configuration ${{ env.BUILD_CONFIG }}
        $endTime = Get-Date
        $duration = ($endTime - $startTime).TotalSeconds
        Write-Host "Tests completed in $duration seconds"
        if ("${{ github.event_name }}" -eq "pull_request" -and $duration -gt 120) {
          Write-Warning "PR tests took longer than 120 seconds ($duration seconds)"
        }

  package-and-release:
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/release/v0.2.0')
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Install WiX Toolset v4.0.4
      run: dotnet tool install --global wix --version 4.0.4

    - name: Build MSI Installer
      run: |
        cd wheel_overlay
        .\build_msi.ps1
      working-directory: ${{ github.workspace }}
      shell: pwsh

    - name: Get Version
      id: get_version
      run: |
        $xml = [xml](Get-Content wheel_overlay/WheelOverlay/WheelOverlay.csproj)
        $version = $xml.Project.PropertyGroup.Version
        echo "VERSION=$version" >> $env:GITHUB_ENV
      working-directory: ${{ github.workspace }}
      shell: pwsh

    - name: Upload MSI Artifact
      uses: actions/upload-artifact@v4
      with:
        name: WheelOverlay-${{ env.VERSION }}-installer
        path: wheel_overlay/Package/WheelOverlay.msi
        retention-days: 7

    - name: Create Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: wheel_overlay/Package/WheelOverlay.msi
        tag_name: v${{ env.VERSION }}
        name: Release v${{ env.VERSION }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
